# =====================================================
# VARIABLES DE AMBIENTE - DESARROLLO
# =====================================================
# Simula Azure DevOps Library Group: "eks-controllers-dev"

# =====================================================
# VERSIONES DE CONTROLADORES
# =====================================================
export LB_CONTROLLER_VERSION=1.16.0
export CLUSTER_AUTOSCALER_VERSION=9.54.0

# =====================================================
# CONFIGURACIÓN DEL CLUSTER
# =====================================================
CLUSTER_NAME=Place-EKS
AWS_REGION=us-east-1
AWS_ACCOUNT_ID=161156235207

# VPC ID del cluster (requerido para Fargate o nodos con IMDS restringido)
# Obtener con: aws eks describe-cluster --name CLUSTER_NAME --query "cluster.resourcesVpcConfig.vpcId" --output text
VPC_ID=vpc-09287afb11a21cd32

# =====================================================
# KARPENTER - NODECLASS CONFIGURATION
# =====================================================
NODECLASS_ENABLED=true
NODECLASS_NAME_OVERRIDE=nodeclass-task
NODECLASS_ROLE=Task-AUTOMODE-Rol

# Subnets para nodos (separados por comas)
NODECLASS_SUBNET_IDS=subnet-0175291f341bd62b1,subnet-0a85cde080c4a99a0,subnet-07fdc6202190e69a5

# Security group del cluster EKS (separados por comas)  
NODECLASS_SG_IDS=sg-072deefbda727e8ae

NODECLASS_EPHEMERAL_SIZE=80Gi
NODECLASS_EPHEMERAL_IOPS=3000
NODECLASS_EPHEMERAL_THROUGHPUT=125
NODECLASS_SNAT_POLICY=Random
NODECLASS_NETWORK_POLICY=DefaultAllow
NODECLASS_NETWORK_POLICY_LOGS=Disabled

# Tags adicionales (formato: key1=value1,key2=value2)
NODECLASS_TAGS=Environment=dev,Team=platform,Name=KARPENTER

# =====================================================
# KARPENTER - NODEPOOL CONFIGURATION
# =====================================================
NODEPOOL_ENABLED=true
NODEPOOL_NAME_OVERRIDE=nodepool-task
NODEPOOL_NODECLASS_REF=nodeclass-task

# Tipos de instancias permitidas (separados por comas)
NODEPOOL_INSTANCE_CATEGORIES=c,m,r.t
NODEPOOL_ZONES=us-east-1a,us-east-1b
NODEPOOL_ARCHITECTURES=amd64,arm64
NODEPOOL_CAPACITY_TYPES=on-demand,spot

NODEPOOL_EXPIRE_AFTER=72h
NODEPOOL_TERMINATION_GRACE_PERIOD=1h
NODEPOOL_CONSOLIDATION_POLICY=WhenEmptyOrUnderutilized
NODEPOOL_CONSOLIDATE_AFTER=60s
NODEPOOL_CPU_LIMIT=1000
NODEPOOL_MEMORY_LIMIT=1000Gi
NODEPOOL_WEIGHT=100

# =====================================================

# =====================================================
# AWS LOAD BALANCER CONTROLLER
# =====================================================
# Habilitar/Deshabilitar el controlador
LB_CONTROLLER_ENABLED=true

# Nombre personalizado - Este será el nombre base de los pods
# Ejemplo: "aws-load-balancer-controller" → pods: aws-load-balancer-controller-xxxxx-xxxxx
LB_CONTROLLER_NAME_OVERRIDE=aws-load-balancer-controller

# IAM Role ARN para IRSA
LB_CONTROLLER_ROLE_ARN=arn:aws:iam::161156235207:role/Task-AWS-Load-Balancer-Controller-Rol

# Recursos (conservadores para dev)
LB_CONTROLLER_REPLICAS=2
LB_CONTROLLER_CPU_REQUEST=100m
LB_CONTROLLER_MEMORY_REQUEST=128Mi
LB_CONTROLLER_CPU_LIMIT=200m
LB_CONTROLLER_MEMORY_LIMIT=256Mi

# Configuraciones adicionales importantes
LB_CONTROLLER_LOG_LEVEL=info  # debug, info, warn, error
LB_CONTROLLER_ENABLE_SHIELD=false  # Habilitar AWS Shield Advanced
LB_CONTROLLER_ENABLE_WAF=false     # Habilitar AWS WAF
LB_CONTROLLER_DEFAULT_TAGS="Environment=dev,ManagedBy=Helm"  # Tags por defecto para ALBs/NLBs

# =====================================================
# CLUSTER AUTOSCALER
# =====================================================
# Habilitar/Deshabilitar el autoscaler
CLUSTER_AUTOSCALER_ENABLED=true  # Deshabilitado en dev para ahorrar costos

# Nombre personalizado - Este será el nombre base de los pods
# Ejemplo: "cluster-autoscaler" → pods: cluster-autoscaler-xxxxx-xxxxx
CLUSTER_AUTOSCALER_NAME_OVERRIDE=cluster-autoscaler

# IAM Role ARN para IRSA
CLUSTER_AUTOSCALER_ROLE_ARN=arn:aws:iam::161156235207:role/Task-ClusterAutoScaler-Rol

# Recursos (conservadores para dev)
CLUSTER_AUTOSCALER_REPLICAS=1
CLUSTER_AUTOSCALER_CPU_REQUEST=100m
CLUSTER_AUTOSCALER_MEMORY_REQUEST=128Mi
CLUSTER_AUTOSCALER_CPU_LIMIT=200m
CLUSTER_AUTOSCALER_MEMORY_LIMIT=256Mi

# Configuración del Cluster Autoscaler
CA_SKIP_NODES_WITH_LOCAL_STORAGE=false
CA_EXPANDER=least-waste
CA_BALANCE_SIMILAR_NODE_GROUPS=true
CA_SKIP_NODES_WITH_SYSTEM_PODS=false

# Configuraciones adicionales importantes
CA_SCALE_DOWN_ENABLED=true           # Permitir reducir nodos
CA_SCALE_DOWN_DELAY_AFTER_ADD=1m    # Esperar antes de reducir después de agregar
CA_SCALE_DOWN_UNNEEDED_TIME=1m      # Tiempo que un nodo debe estar sin usar
CA_SCALE_DOWN_UTILIZATION_THRESHOLD=0.5  # Umbral de utilización para reducir (50%)
CA_MAX_NODE_PROVISION_TIME=15m       # Tiempo máximo para provisionar un nodo
CA_LOG_LEVEL=4                       # Nivel de logs (1-10, 4=info, 6=debug)